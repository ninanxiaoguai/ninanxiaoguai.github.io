---
title: WebScraping-17
date: 2019-08-17 22:29:57
categories: Web-Scraping
tags: 
- Web-Scraping
- python
mathjax: true
---

在上一章中，您了解了如何跨多个线程和进程运行web爬虫，在这些线程和进程之间的通信有些受限，或者必须仔细计划。本章将这一概念引入其逻辑结论，即爬行器不仅在单独的进程中运行，而且在完全独立的机器上运行。

<!--more-->

这一章是这本书的最后一章，这在某种程度上是恰当的。到目前为止，您一直在您的家庭计算机范围内从命令行运行所有Python应用程序。当然，您可能安装MySQL是为了复制真实服务器的环境。但这是不一样的。俗话说:如果你爱一样东西，就给它自由。本章介绍了在不同机器上运行脚本的几种方法，甚至是在您自己的机器上运行不同的IP地址。尽管你可能想把这一步是你现在不需要,你可能会惊讶于自己是多么容易开始使用你现有的工具(如个人网站上支付托管账户),和你的生活变得多么容易得多当你停止尝试的时候从你的笔记本电脑运行Python爬虫。

### Why Use Remote Servers

虽然在启动一个面向广大用户的web应用程序时，使用远程服务器似乎是一个明显的步骤，但是我们为自己的目的构建的工具通常都是在本地运行的。决定使用远程平台的人通常基于两个主要动机:需要更强大的功能和灵活性，以及需要使用另一个IP地址。

#### Avoiding IP Address Blocking

在构建web scraper时，经验法则是:几乎所有东西都可以伪造。您可以从您不拥有的地址发送电子邮件，可以从命令行自动化鼠标移动数据，甚至可以通过Internet Explorer 5.0发送web管理员的网站流量来吓到他们。

唯一不能伪造的是你的IP地址。任何人都可以寄给你回信地址:总统，1600宾夕法尼亚大道西北，华盛顿特区20500。然而，如果这封信的邮戳来自美国阿尔伯克基，你可以相当肯定你没有与美国的总统通信。

阻止抓取者访问网站的大部分努力都集中在检测人类和机器人之间的差异上。到目前为止，封锁IP地址有点像一个农民放弃喷洒农药，而只是焚烧农田。这是丢弃从麻烦的IP地址发送的数据包的最后一招，但很有效。然而，这种解决方案也存在一些问题:

- IP地址访问列表维护起来很麻烦。尽管大型网站通常都有自己的程序来自动化这些列表的一些常规管理(机器人阻止机器人!)
- 每个地址都增加了接收数据包的少量处理时间，因为服务器必须根据列表检查接收到的数据包，以决定是否批准它们。许多地址乘以许多包可以很快地加起来。为了节省处理时间和复杂性，管理员经常将这些IP地址分组成块，并制定规则，例如，如果有一些紧密聚集的违规者，那么这个范围内的所有256个地址都将被阻塞。这就引出了第三点。
- IP地址阻塞也会导致阻塞好人。例如，我在奥林工程学院(Olin College of Engineering)读本科时，一名学生编写了一些软件，试图在`http://digg.com`上为流行内容操纵投票(这是在Reddit流行起来之前)。一个被屏蔽的IP地址导致整个宿舍无法访问该网站。这个学生只是把他的软件转移到另一个服务器上;与此同时，Digg失去了许多主要目标用户的页面访问。

尽管有其缺点，IP地址阻塞仍然是服务器管理员阻止可疑的web抓取器访问服务器的一种非常常见的方法。如果一个IP地址被阻塞，唯一真正的解决方案是从另一个IP地址刮取。这可以通过将scraper移动到新服务器或使用Tor之类的服务通过不同的服务器路由流量来实现。

#### Portability and Extensibility

有些任务对于家庭电脑和互联网连接来说太大了。虽然您不希望在任何单个网站上增加大量负载，但是您可能需要跨多个站点收集数据，并且需要比当前设置所能提供的更多的带宽和存储空间。此外，通过卸载计算密集型处理，您可以为更重要的任务(魔兽世界，有人吗?)你不需要担心电源和网络连接的维护(在星巴克启动你的应用程序，打包你的笔记本电脑，然后离开，知道一切都还在安全运行)，你可以在任何有网络连接的地方访问你收集的数据。如果您的应用程序需要如此强大的计算能力，以至于单个Amazon超大计算实例都不能满足您的要求，那么您还可以考虑分布式计算。这允许多台机器并行工作，以实现您的目标。作为一个简单的例子，您可能让一台机器抓取一组站点，另一台机器抓取另一组站点，并让它们将收集到的数据存储在同一个数据库中。

如果您的应用程序需要如此强大的计算能力，以至于单个Amazon超大计算实例都不能满足您的要求，那么您还可以考虑分布式计算。这允许多台机器并行工作，以实现您的目标。作为一个简单的例子，您可能让一台机器抓取一组站点，另一台机器抓取另一组站点，并让它们将收集到的数据存储在同一个数据库中。当然，正如前面几章所指出的，许多人可以复制谷歌搜索所做的，但是很少有人能复制谷歌搜索所做的规模。分布式计算是计算机科学的一个大领域，超出了本书的范围。然而，学习如何在远程服务器上启动应用程序是必要的第一步，您可能会对当今计算机的功能感到惊讶。

### Tor

洋葱路由器网络(Onion Router network)，缩写Tor更为人所知)是一个由志愿者服务器组成的网络，它们被设置为通过不同服务器的许多层(因此洋葱指的是不同的服务器)路由和重路由流量，以掩盖其起源。数据在进入网络之前是加密的，因此如果任何特定的服务器被窃听，通信的性质就不能被揭示。此外,虽然任何特定的入站和出站通信服务器可以妥协,一个需要知道的细节入站和出站通信路径上的所有服务器通信以破译的真正开始和端点通信一个近乎不可能的壮举。

Tor通常被人权工作者和政治揭发者用来与记者交流，它的大部分资金来自美国政府。
当然，它也经常用于非法活动，因此仍然是政府监视的一个固定目标(尽管到目前为止，监视的效果好坏参半)。

#### limitation

虽然您在本书中使用Tor的原因是为了更改您的IP地址，而不是实现完全匿名本身，但是有必要花一些时间来解决Tor在匿名流量方面的一些优势和限制。虽然您可以假设在使用Tor时，根据web服务器，您来自的IP地址不是可以追溯到您的IP地址，但是您与该web服务器共享的任何信息都可能暴露您。例如，如果您登录到自己的Gmail帐户，然后进行与谷歌有关的搜索，那么这些搜索现在可以与您的身份绑定在一起。然而，在显而易见的之外，即使是登录Tor的行为也可能对您的匿名性造成危险。2013年12月，一名哈佛本科生为了逃避期末考试，用一个匿名电子邮件账户，通过Tor网络向学校发送了一封炸弹威胁邮件。当哈佛大学的IT团队查看他们的日志时，他们发现，在炸弹威胁发出期间，Tor网络的流量仅来自一台注册为已知学生的机器。尽管他们无法确定这些流量的最终目的地(只知道它是通过Tor发送的)，但时间匹配且当时只有一台机器登录的事实足以对这名学生提出起诉。登录Tor并不是一件自动隐身斗篷，也不能让你在互联网上随心所欲。虽然它是一个有用的工具，但一定要谨慎、明智地使用它，当然还有道德。

安装并运行Tor是使用Python with Tor的必要条件，您将在下一节中看到这一点。幸运的是，Tor服务非常容易安装并开始运行。只需进入Tor下载页面并下载、安装、打开和连接!请记住，在使用Tor时，您的internet速度可能会显得比较慢。耐心点，它可能会环游世界好几次!258

#### PySocks

PySocks是一个非常简单的Python模块，它能够通过代理服务器路由流量，并与Tor协同工作。您可以从它的网站上下载它，或者使用任意数量的第三方模块管理器来安装它。

虽然这个模块的文档并不多，但是使用它非常简单。运行此代码时，Tor服务必须运行在端口9150(默认端口)上:

```python
# Must have the TOR service running on port 9150 while running this
import socks
import socket
from urllib.request import urlopen

socks.set_default_proxy(socks.SOCKS5, "localhost", 9150)
socket.socket = socks.socksocket
print(urlopen('http://icanhazip.com').read())
```



网站`http://icanhazip.com`只显示连接到服务器的客户机的IP地址，这对于测试非常有用。运行此脚本时，它应该显示一个不是您自己的IP地址。

如果您想在Tor中使用`Selenium`和`PhantomJS`，您根本不需要`PySocks`——只要确保Tor当前正在运行，并添加可选的`service_args`参数，指定Selenium应该通过端口9150连接:

```python
from selenium import webdriver
from selenium.webdriver.chrome.options import Options

chrome_options = Options()
chrome_options.add_argument("--headless")
chrome_options.add_argument("--proxy-server=socks5://127.0.0.1:9150")
driver = webdriver.Chrome(executable_path='drivers/chromedriver', options=chrome_options)

driver.get('http://icanhazip.com')
print(driver.page_source)
driver.close()
```

同样，这应该打印出一个不是您自己的IP地址，而是您正在运行的Tor客户机当前使用的IP地址。

### Remote Hosting

尽管在你取出信用卡后完全匿名性就消失了，但是远程托管你的网页抓取器可以极大地提高它们的速度。这不仅是因为您能够在比您可能拥有的大得多的机器上购买时间，而且还因为连接不再需要在Tor网络的各个层之间来回跳转才能到达目的地。

#### Running from a Website-Hosting Account

如果您有一个个人或商业网站，您可能已经有办法从外部服务器运行web scraper。即使使用相对锁定的web服务器(您无法访问命令行)，也可以通过web接口触发脚本启动和停止。如果您的网站托管在Linux服务器上，那么服务器很可能已经运行Python。如果您是在Windows服务器上托管，那么您可能就不走运了;您需要特别检查是否安装了Python，或者服务器管理员是否愿意安装它。

大多数小型网站托管提供商都提供cPanel软件，用于提供基本的管理服务和有关网站及相关服务的信息。如果你有访问cPanel的权限，你可以通过进入Apache处理程序并添加一个新的处理程序(如果还没有的话)来确保Python被设置为在你的服务器上运行:

```
Handler: cgi-script
Extension(s): .py
```

这告诉您的服务器，所有Python脚本都应该作为cgi脚本执行。CGI是通用网关接口的缩写，是任何可以在服务器上运行并动态生成网站上显示的内容的程序。通过显式地将Python脚本定义为CGI脚本，您允许服务器执行它们，而不是仅仅在浏览器中显示它们或向用户发送下载。

编写您的Python脚本，将其上载到服务器，并将文件权限设置为755以允许执行它。要执行脚本，请导航到您通过浏览器上载脚本的位置(或者更好的方法是编写一个scraper来为您执行脚本)。如果你担心公众访问和执行脚本，你有两个选择:

- 将脚本存储在一个模糊或隐藏的URL中，并确保永远不要从任何其他可访问的URL链接到脚本，以避免搜索引擎对其进行索引。
- 使用密码保护脚本，或者要求在脚本执行之前向其发送密码或秘密令牌。

当然，从专门用于显示网站的服务中运行Python脚本有点不太好。例如，您可能会注意到您的web剪贴簿兼网站加载速度有点慢。实际上，直到整个爬虫完成，页面才会真正加载(包括您可能已经写入的所有print语句的输出)。这可能需要几分钟、几个小时，或者根本不可能完成，这取决于它是如何编写的。虽然它确实完成了任务，但是您可能需要更多的实时输出。为此，您需要的服务器不仅仅是为web而设计的。

#### Running from the Cloud

在过去的计算时代，程序员为执行代码而在计算机上付费或预留时间。随着个人电脑的出现，你不需要在自己的电脑上编写和执行代码。现在，应用程序的雄心已经超过了微处理器的发展，以至于程序员再次转向按小时付费的计算实例。然而，这一次，用户不再为一台物理机器上的时间付费，而是为它同等的计算能力付费，这种计算能力通常分布在许多机器上。这个系统模糊的结构使得计算能力可以根据需求高峰的时间来定价。例如，当低成本比即时性更重要时，Amazon允许对现场实例进行投标。

计算实例也更加专门化，可以根据应用程序的需要进行选择，选项包括高内存、快速计算和大存储。虽然web抓取器通常不会使用太多内存，但是您可能希望考虑使用大存储或快速计算来替代更通用的抓取应用程序实例。如果您正在进行大量的自然语言处理、OCR工作或路径查找(例如Wikipedia的六度问题)，那么快速计算实例可能会工作得很好。如果您正在抓取大量数据、存储文件或进行大规模分析，那么您可能希望使用存储优化的实例。尽管就花费而言，天空是有限的，但在撰写本文时，实例的启动价格仅为1.3美分/小时(对于Amazon EC2微实例)，谷歌最便宜的实例为4.5美分/小时，最低仅需10分钟。由于规模经济，购买大型公司的小型计算实例与购买自己的物理专用机器是一样的，只是现在，您不需要雇佣IT人员来保持它的运行。

当然，设置和运行云计算实例的分步说明在一定程度上超出了本书的范围，但是您可能会发现不需要分步说明。由于亚马逊和谷歌(更不用说这个行业中无数的小公司了)都在争夺云计算的利润，他们让创建新实例变得非常简单，只需遵循一个简单的提示，想一个应用程序名称，并提供一个信用卡号码。在撰写本文时，Amazon和谷歌都提供了数百美元的免费计算时间，以进一步吸引新客户。

一旦您设置了一个实例，您就应该自豪地拥有一个IP地址、用户名和公钥/私钥，可以使用它们通过SSH连接到您的实例。从这里开始，一切都应该与使用物理上拥有的服务器相同——当然，您不再需要担心硬件维护或运行过多的高级监视工具。

### Additional Resources

许多年前，在云中运行主要是那些喜欢费力阅读文档并且已经有一些服务器管理经验的人的领域。然而，由于云计算提供商之间的日益普及和竞争，这些工具已经得到了极大的改进。不过，对于构建大型或更复杂的抓取器和爬行器，您可能需要更多关于创建用于收集和存储数据的平台的指导。Marc Cohen、Kathryn Hurley和Paul Newson (O Reilly)编写的谷歌计算引擎是一种使用Python和JavaScript的谷歌云计算的直接资源。它不仅涵盖了谷歌的用户界面，而且还包括命令行和脚本工具，您可以使用这些工具为您的应用程序提供更大的灵活性。如果您更喜欢使用Amazon, Mitch Garnaat的Python和AWS Cookbook (O Reilly)是一个简短但非常有用的指南，它将帮助您开始使用Amazon Web Services，并向您展示如何启动和运行一个可伸缩的应用程序。